<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Code Assistant - Integration Test</title>
  <link rel="stylesheet" data-name="vs/editor/editor.main" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/editor/editor.main.css" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1e1e1e;
      color: #d4d4d4;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      padding: 1rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-bottom: 1px solid #3e3e3e;
    }

    .header h1 {
      font-size: 1.25rem;
      font-weight: 600;
    }

    .header p {
      font-size: 0.9rem;
      margin-top: 0.5rem;
      opacity: 0.9;
    }

    .container {
      display: flex;
      flex: 1;
      gap: 1rem;
      padding: 1rem;
    }

    .editor-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      border: 1px solid #3e3e3e;
      border-radius: 4px;
      overflow: hidden;
    }

    .editor-title {
      padding: 0.5rem 1rem;
      background: #252526;
      border-bottom: 1px solid #3e3e3e;
      font-size: 0.9rem;
      font-weight: 500;
    }

    #editor {
      flex: 1;
    }

    .panel {
      width: 350px;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .panel-section {
      display: flex;
      flex-direction: column;
      border: 1px solid #3e3e3e;
      border-radius: 4px;
      overflow: hidden;
    }

    .panel-title {
      padding: 0.5rem 1rem;
      background: #252526;
      border-bottom: 1px solid #3e3e3e;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .panel-content {
      flex: 1;
      overflow-y: auto;
      padding: 0.75rem;
      font-size: 0.85rem;
    }

    .status-item {
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      background: #252526;
      border-left: 3px solid #667eea;
      border-radius: 2px;
    }

    .status-label {
      font-weight: 600;
      color: #4fc3f7;
      margin-bottom: 0.25rem;
    }

    .status-value {
      font-size: 0.8rem;
      color: #b0bec5;
    }

    .status-value.active {
      color: #81c784;
    }

    .status-value.locked {
      color: #e57373;
    }

    .log-entry {
      margin-bottom: 0.25rem;
      padding: 0.25rem 0.5rem;
      border-radius: 2px;
      font-family: 'Courier New', monospace;
    }

    .log-entry.info {
      color: #4fc3f7;
    }

    .log-entry.success {
      color: #81c784;
    }

    .log-entry.error {
      color: #e57373;
    }

    .log-entry.warn {
      color: #ffb74d;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ðŸ”— Integration Test - FIM + Dispatcher</h1>
    <p>Test FIM with Dispatcher coordination. Edit code to trigger symptom detection.</p>
  </div>

  <div class="container">
    <div class="editor-section">
      <div class="editor-title">Editor</div>
      <div id="editor"></div>
    </div>

    <div class="panel">
      <div class="panel-section">
        <div class="panel-title">Status</div>
        <div class="panel-content" id="status">
          <div class="status-item">
            <div class="status-label">FIM Status</div>
            <div class="status-value" id="fim-status">Ready</div>
          </div>
          <div class="status-item">
            <div class="status-label">NES Status</div>
            <div class="status-value" id="nes-status">Sleeping</div>
          </div>
          <div class="status-item">
            <div class="status-label">Edit Count</div>
            <div class="status-value" id="edit-count">0</div>
          </div>
          <div class="status-item">
            <div class="status-label">Last Symptom</div>
            <div class="status-value" id="last-symptom">None</div>
          </div>
        </div>
      </div>

      <div class="panel-section">
        <div class="panel-title">Console</div>
        <div class="panel-content" id="console"></div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
  <script>
    require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' } });

    const consoleDiv = document.getElementById('console');
    let editCount = 0;

    function addLog(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      consoleDiv.appendChild(entry);
      consoleDiv.scrollTop = consoleDiv.scrollHeight;
    }

    function updateStatus(key, value) {
      const elem = document.getElementById(key);
      if (elem) {
        elem.textContent = value;
        if (key === 'fim-status' && value === 'Locked') {
          elem.className = 'status-value locked';
        } else if (key === 'nes-status' && value === 'Active') {
          elem.className = 'status-value active';
        } else {
          elem.className = 'status-value';
        }
      }
    }

    const originalLog = console.log;
    const originalError = console.error;

    console.log = function (...args) {
      originalLog(...args);
      addLog(args.join(' '), 'info');
    };

    console.error = function (...args) {
      originalError(...args);
      addLog(args.join(' '), 'error');
    };

    require(['vs/editor/editor.main'], async function () {
      console.log('âœ… Monaco Editor loaded');

      const { initAICodeAssistant } = await import('../ai-code-assistant/index.ts');

      const editor = monaco.editor.create(document.getElementById('editor'), {
        value: `// Integration Test

function calculateSum(a, b) {
  return a + b;
}

const result = calculateSum(1, 2);
console.log(result);
`,
        language: 'typescript',
        theme: 'vs-dark',
        fontSize: 14,
        glyphMargin: true,
        automaticLayout: true,
        minimap: { enabled: false },
      });

      console.log('âœ… Editor created');

      try {
        const assistant = initAICodeAssistant(monaco, editor, {
          fim: {
            enabled: true,
            endpoint: 'http://localhost:3000/api/completion',
          },
          nes: {
            enabled: true,
            endpoint: 'http://localhost:3000/api/next-edit-prediction',
          },
        });

        console.log('âœ… AI Code Assistant initialized');

        // Monitor edits
        editor.onDidChangeModelContent(() => {
          editCount++;
          updateStatus('edit-count', editCount);
        });

        console.log('Ready for testing. Try editing the code...');
      } catch (error) {
        console.error('Failed to initialize:', error);
      }
    });
  </script>
</body>
</html>
